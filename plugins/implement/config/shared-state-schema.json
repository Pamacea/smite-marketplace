{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SMITE Shared State",
  "description": "Shared state schema for parallel agent coordination",
  "type": "object",
  "required": ["session_id", "timestamp", "status", "mode", "agents"],
  "properties": {
    "session_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this coordination session"
    },
    "parent_session": {
      "type": "string",
      "description": "Parent session ID if this is a sub-session"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Session creation time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "Last update time"
    },
    "status": {
      "type": "string",
      "enum": ["initializing", "running", "completed", "failed", "cancelled"],
      "description": "Current session status"
    },
    "mode": {
      "type": "string",
      "enum": ["quick", "epct", "builder", "predator", "ralph"],
      "description": "Implementation mode being used"
    },
    "phase": {
      "type": "string",
      "description": "Current phase within the mode"
    },
    "agents": {
      "type": "object",
      "description": "Agent tracking",
      "properties": {
        "active": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Currently running agents"
        },
        "completed": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Completed agents"
        },
        "failed": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Failed agents"
        },
        "pending": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Agents waiting to start"
        }
      }
    },
    "context": {
      "type": "object",
      "description": "Shared execution context",
      "properties": {
        "task": {
          "type": "string",
          "description": "Primary task description"
        },
        "files": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": {"type": "string"},
              "status": {"type": "string", "enum": ["pending", "read", "modified", "created"]},
              "agent": {"type": "string", "description": "Agent responsible for this file"}
            }
          }
        },
        "dependencies": {
          "type": "object",
          "description": "Dependency graph between tasks"
        },
        "flags": {
          "type": "object",
          "description": "Command-line flags and options"
        }
      }
    },
    "results": {
      "type": "object",
      "description": "Agent results storage",
      "additionalProperties": {
        "oneOf": [
          {"type": "null"},
          {"type": "object"},
          {"type": "array"},
          {"type": "string"}
        ]
      }
    },
    "shared": {
      "type": "object",
      "description": "Shared data bus for agent communication",
      "properties": {
        "patterns": {
          "type": "object",
          "description": "Discovered code patterns"
        },
        "types": {
          "type": "object",
          "description": "Type definitions found"
        },
        "components": {
          "type": "object",
          "description": "Component inventory"
        },
        "imports": {
          "type": "object",
          "description": "Import dependencies"
        },
        "errors": {
          "type": "array",
          "items": {"type": "object"},
          "description": "Shared error collection"
        }
      }
    },
    "messages": {
      "type": "array",
      "description": "Inter-agent message queue",
      "items": {
        "type": "object",
        "properties": {
          "id": {"type": "string"},
          "from": {"type": "string"},
          "to": {"type": "string"},
          "type": {"type": "string", "enum": ["query", "response", "notification", "error"]},
          "payload": {"type": "object"},
          "timestamp": {"type": "string", "format": "date-time"},
          "read": {"type": "boolean"}
        }
      }
    },
    "lock": {
      "type": "object",
      "description": "State lock for concurrent access",
      "properties": {
        "held_by": {"type": "string"},
        "acquired_at": {"type": "string", "format": "date-time"},
        "expires_at": {"type": "string", "format": "date-time"}
      }
    },
    "metrics": {
      "type": "object",
      "description": "Session metrics",
      "properties": {
        "agents_launched": {"type": "integer"},
        "agents_completed": {"type": "integer"},
        "agents_failed": {"type": "integer"},
        "total_duration_ms": {"type": "integer"},
        "parallel_speedup": {"type": "number"}
      }
    }
  }
}
